<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Campus Map Builder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: sans-serif; }
        #sidebar { width: 300px; padding: 20px; background: #f4f4f4; box-shadow: 2px 0 5px rgba(0,0,0,0.1); z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        #map { flex-grow: 1; }
        button { padding: 10px; cursor: pointer; font-size: 16px; }
        .active { background-color: #4CAF50; color: white; }
        textarea { height: 100px; font-family: monospace; }
        .hint { font-size: 12px; color: #666; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Map Builder</h2>
    
    <div>
        <label>1. Load Data</label>
        <button id="loadBtn">Load data/data.geojson</button>
        <p class="hint">If that fails (local CORS), upload here:</p>
        <input type="file" id="fileInput" accept=".geojson,.json">
    </div>

    <hr>

    <label>2. Edit Mode</label>
    <button id="addLocationBtn">Add Location (Point)</button>
    <button id="addPathBtn">Add Path (Line)</button>
    <p id="modeStatus" class="hint">Mode: View</p>
    <p class="hint">Path: Click points, DblClick to finish.</p>

    <hr>

    <label>3. Save</label>
    <button id="downloadBtn">Download data.geojson</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    // Initialize Map
    var map = L.map('map').setView([12.9240, 77.4990], 17);
    L.tileLayer('https://api.maptiler.com/maps/streets-v2/{z}/{x}/{y}.png?key=YmEOZSxLEE87oOVe10Ps', {
        maxZoom: 22,
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let geoJsonLayer;
    let currentData = { type: "FeatureCollection", features: [] };
    let currentMode = 'view';
    let currentPath = [];
    let tempPathLine = null;

    // Load Data
    const loadData = (data) => {
        currentData = data;
        if (geoJsonLayer) map.removeLayer(geoJsonLayer);
        geoJsonLayer = L.geoJSON(currentData, {
            onEachFeature: (feature, layer) => {
                if (feature.properties && feature.properties.name) {
                    layer.bindPopup(feature.properties.name);
                }
            }
        }).addTo(map);
        console.log("Data loaded", currentData);
    };

    document.getElementById('loadBtn').addEventListener('click', () => {
        fetch('data/data.geojson')
            .then(res => res.json())
            .then(data => loadData(data))
            .catch(err => alert("Could not auto-load (likely CORS). Please select the file manually."));
    });

    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => loadData(JSON.parse(event.target.result));
        reader.readAsText(file);
    });

    // Modes
    const setMode = (mode) => {
        currentMode = mode;
        document.getElementById('modeStatus').innerText = "Mode: " + mode;
        document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        if(mode === 'location') document.getElementById('addLocationBtn').classList.add('active');
        if(mode === 'path') document.getElementById('addPathBtn').classList.add('active');
        
        // Reset temp path
        currentPath = [];
        if(tempPathLine) map.removeLayer(tempPathLine);
    };

    document.getElementById('addLocationBtn').addEventListener('click', () => setMode('location'));
    document.getElementById('addPathBtn').addEventListener('click', () => setMode('path'));

    // Map Interaction
    map.on('click', (e) => {
        if (currentMode === 'location') {
            const name = prompt("Enter location name:");
            if (name) {
                const newFeature = {
                    type: "Feature",
                    properties: { name: name },
                    geometry: {
                        type: "Point",
                        coordinates: [e.latlng.lng, e.latlng.lat] // GeoJSON is [Lon, Lat]
                    }
                };
                currentData.features.push(newFeature);
                loadData(currentData); // Redraw
                
                // Optional: Flash message
            }
        } else if (currentMode === 'path') {
            currentPath.push([e.latlng.lat, e.latlng.lng]); // Leaflet Polyline uses [Lat, Lng]
            
            if (tempPathLine) map.removeLayer(tempPathLine);
            tempPathLine = L.polyline(currentPath, {color: 'red'}).addTo(map);
        }
    });

    // Finish Path on Double Click
    map.on('dblclick', (e) => {
        if (currentMode === 'path' && currentPath.length > 1) {
            const newFeature = {
                type: "Feature",
                properties: {},
                geometry: {
                    type: "LineString",
                    coordinates: currentPath.map(p => [p[1], p[0]]) // Convert back to [Lon, Lat]
                }
            };
            currentData.features.push(newFeature);
            loadData(currentData);
            setMode('view');
        }
    });

    // Download
    document.getElementById('downloadBtn').addEventListener('click', () => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "data.geojson");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    });

</script>

</body>
</html>
